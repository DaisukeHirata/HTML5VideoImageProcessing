<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Video Frames</title>
    <link rel="stylesheet" href="style.css">
    <style>
      #movieclip {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>Avoid cross domain security error. $ http-server -p 8000 </header>
    <canvas id="canvas" width="600" height="360"></canvas>
    <input id="hue" type="range" min="-180" max="180" step="1"/>
    <input id="saturation" type="range" min="-100" max="100" step="1"/>
    <input id="lightness" type="range" min="-100" max="100" step="1"/>
    <aside>Video file may take a moment to load.</aside>

    <video id="movieclip" width="640" height="360" autoplay>
      <source src="./assets/movieclip.mp4" type="video/mp4"/>
      <source src="./assets/movieclip.webm" type="video/webm"/>
      <source src="./assets/movieclip.ogv" type="video/ogg"/>
    </video>
  
    <script src="utils.js"></script>
    <script src="Stats.js"></script>
    <script>
    window.onload = function () {

      var canvas = document.getElementById('canvas'),
          context = canvas.getContext('2d'),
          copyContext = createCopyContext(canvas), 
          video = document.getElementById('movieclip'),
          stats = Stat.initStats();

      function createCopyContext (canvas) {
        var copy = document.createElement('canvas');
        copy.width = canvas.width;
        copy.height = canvas.height;
        return copy.getContext('2d');
      }

      function hst (imageData, hue, saturation, lightness) {

        hue = (hue % 360) / 360;
        saturation = saturation / 100;
        lightness = lightness / 100; 

        var hue6     = hue * 6,
            satMul   = saturation < 0 ? (1+saturation) : (1+saturation*2), // this seems to give the same result as Photoshop
            light255 = lightness * 255,
            lightp1  = 1 + lightness,
            lightm1  = 1 - lightness;      
            pixels   = imageData.data;

        //pixel iteration
        for (var y = 0; y < imageData.height; y++) {
          for (var x = 0; x < imageData.width; x++) {

            var offset = (x + y * imageData.width) * 4,
                r = pixels[offset],
                g = pixels[offset + 1],
                b = pixels[offset + 2];

            if (hue != 0 || saturation != 0) {
              // ok, here comes rgb to hsl + adjust + hsl to rgb, all in one jumbled mess. 
              // It's not so pretty, but it's been optimized to get somewhat decent performance.
              // The transforms were originally adapted from the ones found in Graphics Gems, but have been heavily modified.
              var vs = r;
              if (g > vs) vs = g;
              if (b > vs) vs = b;
              var ms = r;
              if (g < ms) ms = g;
              if (b < ms) ms = b;
              var vm = (vs-ms);
              var l = (ms+vs)/510;
              if (l > 0) {
                if (vm > 0) {
                  if (l <= 0.5) {
                    var s = vm / (vs+ms) * satMul;
                    if (s > 1) s = 1;
                    var v = (l * (1+s));
                  } else {
                    var s = vm / (510-vs-ms) * satMul;
                    if (s > 1) s = 1;
                    var v = (l+s - l*s);
                  }
                  if (r == vs) {
                    if (g == ms)
                      var h = 5 + ((vs-b)/vm) + hue6;
                    else
                      var h = 1 - ((vs-g)/vm) + hue6;
                  } else if (g == vs) {
                    if (b == ms)
                      var h = 1 + ((vs-r)/vm) + hue6;
                    else
                      var h = 3 - ((vs-b)/vm) + hue6;
                  } else {
                    if (r == ms)
                      var h = 3 + ((vs-g)/vm) + hue6;
                    else
                      var h = 5 - ((vs-r)/vm) + hue6;
                  }
                  if (h < 0) h+=6;
                  if (h >= 6) h-=6;
                  var m = (l+l-v);
                  var sextant = h>>0;
                  if (sextant == 0) {
                    r = v*255; g = (m+((v-m)*(h-sextant)))*255; b = m*255;
                  } else if (sextant == 1) {
                    r = (v-((v-m)*(h-sextant)))*255; g = v*255; b = m*255;
                  } else if (sextant == 2) {
                    r = m*255; g = v*255; b = (m+((v-m)*(h-sextant)))*255;
                  } else if (sextant == 3) {
                    r = m*255; g = (v-((v-m)*(h-sextant)))*255; b = v*255;
                  } else if (sextant == 4) {
                    r = (m+((v-m)*(h-sextant)))*255; g = m*255; b = v*255;
                  } else if (sextant == 5) {
                    r = v*255; g = m*255; b = (v-((v-m)*(h-sextant)))*255;
                  }
                }
              }
            }

            if (lightness < 0) {
              r *= lightp1;
              g *= lightp1;
              b *= lightp1;
            } else if (lightness > 0) {
              r = (r * lightm1) + light255;
              g = (g * lightm1) + light255;
              b = (b * lightm1) + light255;
            }

            if (r < 0) 
              pixels[offset] = 0
            else if (r > 255)
              pixels[offset] = 255
            else
              pixels[offset] = r;

            if (g < 0) 
              pixels[offset + 1] = 0
            else if (g > 255)
              pixels[offset + 1] = 255
            else
              pixels[offset + 1] = g;

            if (b < 0) 
              pixels[offset + 2] = 0
            else if (b > 255)
              pixels[offset + 2] = 255
            else
              pixels[offset + 2] = b;

          }
        }
      }

      (function drawFrame () {

        stats.begin();

        window.requestAnimationFrame(drawFrame, canvas);
        copyContext.drawImage(video, 0, 0);

        var imageData  = copyContext.getImageData(0, 0, canvas.width, canvas.height);
            hue        = parseInt(document.getElementById('hue').value, 10) || 0,
            saturation = parseInt(document.getElementById('saturation').value, 10) || 0,
            lightness  = parseInt(document.getElementById('lightness').value, 10) || 0; 

        hst(imageData, hue, saturation, lightness);

        context.putImageData(imageData, 0, 0);

        stats.end();

      }());
    };
    </script>
  </body>
</html>
